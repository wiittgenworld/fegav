<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB to DOCX Converter (Fixed Images)</title>
    <style>
        /* ... (Your existing CSS remains the same) ... */
        body { font-family: -apple-system, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f4f4f9; color: #333; }
        .container { text-align: center; background: white; padding: 2rem 3rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
        .drop-area { border: 2px dashed #ccc; border-radius: 12px; padding: 40px 20px; background-color: #fafafa; margin-bottom: 20px; cursor: pointer; color: #777; }
        .drop-area:hover { border-color: #007bff; background-color: #f0f8ff; color: #007bff; }
        .custom-upload-btn { display: inline-block; background-color: #007bff; color: white; padding: 12px 30px; border-radius: 6px; cursor: pointer; }
        #status { margin-top: 1.5rem; font-size: 0.9rem; color: #666; }
        input[type="file"] { display: none; }
    </style>

    <!-- Essential Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>EPUB to DOCX</h1>
        <div id="dropZone" class="drop-area">
            <span style="font-size: 3rem; display: block; margin-bottom: 10px;">ðŸ“‚</span>
            <span>Drag & Drop EPUB here</span>
        </div>
        <div>
            <label for="fileInput" class="custom-upload-btn">Select File</label>
            <input type="file" id="fileInput" accept=".epub">
        </div>
        <div id="status">
            <span id="statusText">Waiting for file...</span>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const statusText = document.getElementById('statusText');
        const dropZone = document.getElementById('dropZone');

        // --- NEW HELPER FUNCTION TO HANDLE IMAGES ---
        async function convertImagesToBase64(doc, book) {
            const images = doc.querySelectorAll('img');
            
            // Loop through every image tag found in the chapter
            for (let img of images) {
                const src = img.getAttribute('src');
                if (!src) continue;

                try {
                    // 1. Resolve the relative path (e.g., "../img/cover.jpg") to the internal file path
                    // doc.baseURI is crucial here as it tells us where the current chapter file lives
                    const absolutePath = book.path.resolve(src, doc.baseURI);
                    
                    // 2. Fetch the image file from the EPUB archive
                    // 'book.archive.createUrl' creates a temporary Blob URL that the browser can read
                    const url = await book.archive.createUrl(absolutePath);
                    
                    // 3. Fetch that blob and convert it to Base64
                    if (url) {
                        const response = await fetch(url);
                        const blob = await response.blob();
                        const base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });

                        // 4. Replace the src with the Base64 data
                        img.setAttribute('src', base64);
                        
                        // Clean up memory
                        URL.revokeObjectURL(url);
                    }
                } catch (err) {
                    console.warn(`Could not process image: ${src}`, err);
                }
            }
            return doc;
        }

        const processFile = async (file) => {
            if (!file) return;
            statusText.textContent = "Reading EPUB structure...";
            
            try {
                const buffer = await file.arrayBuffer();
                const book = ePub(buffer);
                await book.ready;

                let fullHtml = `<!DOCTYPE html><html><body>`;
                const spine = book.spine;

                for (const item of spine.items) {
                    statusText.textContent = `Processing section ${item.index + 1} of ${spine.items.length}...`;

                    try {
                        // Load the chapter Document
                        let doc = await book.load(item.href);

                        // --- NEW: Run the image converter before getting HTML ---
                        if (doc instanceof Document) {
                            await convertImagesToBase64(doc, book);
                            
                            // Now extract the HTML *after* images are fixed
                            fullHtml += doc.body.innerHTML;
                            fullHtml += '<br style="page-break-after: always;" />';
                        }
                    } catch (e) {
                        console.warn("Skipping chapter:", e);
                    }
                }

                fullHtml += "</body></html>";

                statusText.textContent = "Generating Word document...";
                const converted = htmlDocx.asBlob(fullHtml, {
                    orientation: 'portrait',
                    margins: { top: 720, bottom: 720, left: 720, right: 720 }
                });

                saveAs(converted, file.name.replace(/\.epub$/i, '') + ".docx");
                statusText.textContent = "Done!";

            } catch (err) {
                console.error(err);
                statusText.textContent = "Error: " + err.message;
            } finally {
                fileInput.value = '';
            }
        };

        // Event Listeners (Same as before)
        fileInput.addEventListener('change', (e) => processFile(e.target.files[0]));
        dropZone.addEventListener('click', () => fileInput.click());
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
        });
        dropZone.addEventListener('drop', (e) => processFile(e.dataTransfer.files[0]));
    </script>
</body>
</html>
